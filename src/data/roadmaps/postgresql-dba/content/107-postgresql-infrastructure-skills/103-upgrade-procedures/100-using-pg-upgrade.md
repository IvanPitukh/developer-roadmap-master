# Using pg_upgrade

`pg_upgrade` is a utility that allows you to perform an in-place upgrade of your PostgreSQL database cluster to a new major version, minimizing downtime. It is a faster and more convenient method when compared to the traditional dump and reload upgrade procedure. In this section, we'll briefly discuss how to use `pg_upgrade` to upgrade your PostgreSQL cluster.

## Prerequisites

Before using `pg_upgrade`, ensure that:

- The new PostgreSQL version is installed on your system.
- The old and new versions of `pg_ctl` and `postgres` executables are in your `PATH`.
- The database system catalogs are backed up.

## Steps to perform pg_upgrade

Follow these steps to upgrade your PostgreSQL cluster using `pg_upgrade`:

- **Stop the old PostgreSQL cluster:** Shutdown the old cluster using `pg_ctl` command, like:
   ```
   pg_ctl -D /path/to/old/data/directory stop
   ```
   
- **Run the pg_upgrade command:** Execute the `pg_upgrade` command with appropriate options. A basic example:
   ```
   pg_upgrade -b /path/to/old/bin -B /path/to/new/bin \
              -d /path/to/old/data -D /path/to/new/data \
              --check
   ```
   Here,
   `-b` and `-B` specify the paths to the old and new `bin` directories, respectively.
   `-d` and `-D` specify the paths to the old and new data directories, respectively.
   `--check` option performs a test run, checking for any potential issues without performing the actual upgrade.

- **Analyze the test results:** If the `--check` option reports any issues, address them before proceeding with the actual upgrade.

- **Run the actual pg_upgrade:** Execute the `pg_upgrade` command without the `--check` option to perform the actual upgrade:
   ```
   pg_upgrade -b /path/to/old/bin -B /path/to/new/bin \
              -d /path/to/old/data -D /path/to/new/data
   ```

- **Analyze the new cluster:** Run the `analyze_new_cluster.sh` script generated by `pg_upgrade`. This script will perform an `ANALYZE` operation on the new cluster to update optimizer statistics.

- **Start the new PostgreSQL cluster:** Use the `pg_ctl` command to start the new cluster:
   ```
   pg_ctl -D /path/to/new/data/directory start
   ```

- **Perform a cleanup:** Once you are satisfied with the new cluster's performance, clean up the old cluster's data and configuration files by running the generated `delete_old_cluster.sh` script.

That's it! With these steps, you should have successfully upgraded your PostgreSQL cluster using `pg_upgrade`. For more information about `pg_upgrade`, its options and troubleshooting, refer to the [official PostgreSQL documentation](https://www.postgresql.org/docs/current/pgupgrade.html).